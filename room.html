<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10" > 
    <script type="text/javascript" src="js/nePublisher.min.js" ></script>
    <link rel="stylesheet" type="text/css" href="http://www.bootcss.com/p/buttons/css/buttons.css">
    <link href="http://gz.ybinu.cn/video5.18/css/video-js.css" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css" />
    <!--<link rel="stylesheet" href="http://lyg.goluckin.com/themes/css/app.css" />-->
    <script src="http://gz.ybinu.cn/video5.18/js/video.min.js"></script>
    <script src="http://gz.ybinu.cn/video5.18/js/videojs-ie8.min.js"></script>
    <style type="text/css">
        .m-input {
            margin-bottom: 10px;
        }
        .u-input-name {
            display: inline-block;
            width: 85px;
        }
        .u-input {
            width: 500px;
            height: 25px;
            border: none;
            border-bottom: 1px solid #000;
            outline: none;
            color: #000;
        }
        .testBtn {
            width: 150px;
        }
        .u-status {
            margin-left: 10px;
            display: inline-block;
        }
        .ation {
		    display: inline-block;
		    width: 34px;
		    height: 34px;
		    line-height: 34px;
		    position: relative;
		}
        .operation_raise {
        	background: url(img/bg_smaall.png) no-repeat;
		    background-position: -100px -1px;
		}
    </style>
</head>

<body>
	<div style="position: absolute;z-index: -100;">
    	<h1>NePublisher Demo</h1>
	    <div class="m-input">
	        <span class="u-input-name">摄像头：</span>
	        <select class="u-input" id="cameraSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">麦克风：</span>
	        <select class="u-input" id="microPhoneSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">清晰度：</span>
	        <select class="u-input" id="qualitySelect">
	            <option value="0">流畅（480*360@20）</option>
	            <option value="1">标清（640*480@20）</option>
	            <option value="2">高清（960*540@20）</option>
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">推流地址：</span>
	        <input class="u-input" type="text" id="publishUrl" value="rtmp://p9a6d110b.live.126.net/live/382830b04fe7421198f7902b979c327f?wsSecret=9583a1918b556481db896d7c73add3ae&wsTime=1559538578">
	    </div>
	    <div class="m-input">
	        <button class="button button-primary button-rounded testBtn" id="previewBtn" onclick="startPreview()">预览</button>
	        <button class="button button-primary button-rounded testBtn" id="publishBtn" onclick="startPublish()">开始直播</button>
	        <span class="u-status"></span>
	    </div>
	    <div style="height: 1px;overflow: hidden;opacity: 0;">
	    	
	    </div>
    </div>
    <div class="main">
        <div class="flex just-between">
            <div class="gs-title">
                <span class="gs-live-in">直播未开始
                	<a class="ation operation_raise " href="javascript:;"></a>
                </span>
                <?=$userinfo['uid']?> 角色
                    <?=$userinfo['roleName']?>
            </div>
            <div class="color-fff" style="font-size: 14px;">欢迎您,
                <?=$userinfo['name']?>
            </div>
        </div>
        <div class="content flex">
            <div class="content-left">
                <div class="content-left-top back">
                    <video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
							<source id="my-source" src="rtmp://no3.ybinu.cn:1935/hls/14ea81d3ada5490cb1b2d128d109bca0" type="rtmp/flv">
							<!--<source src="rtmp://ns8.indexforce.com/home/mystream" type="rtmp/flv">-->
						</video>
                    <!--<embed width="300" height="70" class="openFlash" style="position:absolute;top:0;z-Index:9999;" type="application/x-shockwave-flash">-->
                </div>
                <div class="content-left-bottom back mt-10 flex flex-column">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>问答</div>
                            <div>
                                <input type="checkbox">只看我
                            </div>
                        </div>
                    </div>
                    <div class="flex1 subList-online">
                        <ul id="subList-online">
                            <li>
                                <img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />asd
                            </li>
                        </ul>
                    </div>
                    <div class="color-fff quiz">
                        专家为你解答疑惑
                        <div style="margin-top: 10px;">
                            <textarea></textarea>
                            <input class="btn" type="button" value="提问">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex1 ml-10 flex flex-column">
                <div class="content-center back flex just-center align-center">
                    <!-- <img src="./img/doc_bg.png" style="width: 260px;"> -->
                    <div id="my-publisher"></div>
                    <!-- <img src="./img/doc_bg.png" style="width: 260px;"> -->
                    <video id="my-video" style="color:black;width:100%;height:100%" class="video-js vjs-big-play-centered" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
						<source src="rtmp://no3.ybinu.cn:1935/hls/<?php echo $roomid?>" type="rtmp/flv">
						<!--<source src="rtmp://ns8.indexforce.com/home/mystream" type="rtmp/flv">-->
					</video>
                    <!--<embed width="300" height="70" class="openFlash" style="position:absolute;z-Index:9999;" type="application/x-shockwave-flash">-->
                </div>
                <div class="content-bottom back mt-10">
                	<div class="flex align-center" style="height: 100%;padding: 0 1rem;">
                		<div id="worklist">作业列表</div>
                	</div>
                </div>
            </div>
            <div class="content-right back ml-10">
                <div class="flex flex-column" style="height: 100%;">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>聊天</div>
                            <div>
                                <input class="my-checkbox" type="checkbox">只看我
                            </div>
                        </div>
                    </div>
                    <div class="flex stutent-list">
                        <ul id="subList"></ul>
                    </div>
                    <div class="color-fff quiz">
                        发表评论
                        <div style="margin-top: 10px;" class="flex just-between">
                            <textarea id="send" class="flex"></textarea>
                            <input class="btn" id="btn" type="button" value="发送">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="qiehuan">切换</button>
        
    </div>
</body>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="http://lyg.goluckin.com/themes/js/layer.js" ></script>
<script type="text/javascript" src="http://lyg.goluckin.com/themes/js/common.js" ></script>
<!--<script type="text/javascript" src="js/common.js"></script>-->
<script type="text/javascript">
    $(function() {
        var roomid = '26'; //房间号
        var userid = 'ff045dd98a4e479887d2bf168ee0548f';
        var isBottom = true; //是否刷新到底部
        var times = ''; //计时器
        fetch(); //初始化聊天列表
        fetchStuent(); //初始化学生直播窗口
        isRoleName=false;
        if(isRoleName){
        	$("#my-video").remove();
        }else{
        	$("#my-publisher").remove();
        }
        function fetch() {
            var checkboxs = $(".my-checkbox")[0].checked;
            var obj = {};
            if (checkboxs) {
                obj = {
                    roomid: roomid,
                    userid: userid
                }
            } else {
                obj = {
                    roomid: roomid
                }
            }
            $.get(API + "chatContent", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '';
                res.data.forEach(function(item) {
                    html += `<li class="flex">
								<div>
									<img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png"  style="width: 40px;"/>
								</div>
								<div>
									<div class="title">${item.chatname} [${getLocalTime(item.ctime)}]</div>
									<div class="title_content">${item.chatcontent}</div>
								</div>
							</li>`
                })
                $("#subList").html(html);
                if (isBottom) {
                    $(".stutent-list").animate({
                        scrollTop: $(".stutent-list")[0].scrollHeight
                    }, 400);
                    isBottom = false;
                } else {
                    var sLT = $(".stutent-list")[0].scrollTop;
                    var sLSH = $(".stutent-list")[0].scrollHeight;
                    var sLH = $(".stutent-list").height();
                    if (sLT > sLSH - sLH) {
                        $(".stutent-list").animate({
                            scrollTop: sLSH
                        }, 400);
                    };
                }
                times = setTimeout(function() {
                    fetch();
                }, 6000)
            })
        }
        //学生窗口
        function fetchStuent() {
            $.get(API + "getstuadr", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.url) {
//                  changeSrc(res.url);
                }
                setTimeout(function() {
                    fetchStuent();
                }, 10000)
            })
            $.get(API + "getuseronline", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = "";
                res.data.forEach(function(item) {
                    html += `<li data-id="${item.uid}">
								<img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />${item.name}
							</li>`
                })
                $("#subList-online").html(html);
                $("#subList-online li").on("click", function() {
                    changeSrc("rtmp://no3.ybinu.cn:1935/hls/"+$(this).attr("data-id"))
                })
            })
        }
        //监听发送回车
        $("#send").on('keydown', function(e) {
            if (e.keyCode != 13) {
                return;
            } else { //当按键输入为回车时，执行下列操作
                event.preventDefault(); //为了兼容IE8
                e.returnValue = false;
                send();
            }
        });
        //发送按钮
        $("#btn").on("click", function() {
                send();
            })
            //发送消息
        function send() {
            var sendVal = $("#send").val();
            if (sendVal == '') {
                alert("发送不能为空！")
                return;
            }
            var checkboxs = $(".my-checkbox")[0].checked,
                obj = {};
            obj = {
                roomid: roomid,
                userid: 'ff045dd98a4e479887d2bf168ee0548f',
                content: sendVal
            }
            if (checkboxs) {
                obj.touser = 'ff045dd98a4e479887d2bf168ee0548f';
            }
            $.get(API + "sendmsg", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    alert(res.msg);
                    return;
                }
                $("#send").val('');
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        }
        //改变学生窗口播放源
        changeStu("14a10b2857644588aa2c3a9649dd29cb")
        function changeStu(id){
        	$.get(API + "setstuadr", {
                roomid: "573779c109654fdea7ec67695833d402",
                stuid:id
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                clearTimeout(timesS);
                fetchStuent();
                layer.msg("切换成功");
            })
        }
        function changeSrc(src) {
        	var videoPlayer = $("#my-video2").get(0);
        	if (typeof (videoPlayer) != "undefined") {
        		var myPlayer = videojs('my-video2');
        		myPlayer.dispose();
        		var id="my-video2";
        		$(".content-left-top").html(`<video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
							<source id="my-source" src="${src}" type="rtmp/flv">
						</video>`);
	            //设置资源路径
	            $(".content-left-top").attr("src", src);
	            videojs(id, {}, function () { //自动播放
	                // Player (this) is initialized and ready.
	                var myPlayer = videojs(id);
	                videojs(id).ready(function () {
	                    var myPlayer2 = this;
	                    myPlayer2.play();
	                });
	            });
        	}
//          var myPlayera = videojs("my-video2");
//          myPlayera.dispose();
//	        myPlayera.src(src); //重新初始化视频地址
//	        myPlayera.load(src);
//	        myPlayera.play(src);
//	        $(".content-left-models").hide();
	    }
        $("#qiehuan").on("click",function(){
        	changeSrc("rtmp://ns8.indexforce.com/home/mystream")
        })
        $("#worklist").on("click",function(){
        	$.get(API + "teacher_homework_list", {
                liveid: '999e4ee805745a5a3322916203384930'
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '<ul class="material">';
                res.data&&res.data.forEach(function(item) {
                    html += `<li class="flex just-between">
				                <div>${item.clName}</div>
				                <a href="${item.path}" target="_blank" class="material_btn">下载</a>
				            </li>`
                })
                html+='</ul>';
                layer.open({
				  title: '作业列表',
					  area:['500px','auto'],
					  btn:[],
					  content: html
				}); 
            })
        })
        //开始上课
        $.get("http://www.xueerqin.net:9526/cloud/api/beginClasses", {
            roomid: roomid
        }, function(res) {
            typeof res == "string" && (res = JSON.parse(res));
        })
        window.onunload = onunload_handler; 
	    function onunload_handler(){
	        $.get("http://www.xueerqin.net:9526/cloud/api/endClasses", {
	            userId: userid,
	            roleCode:'',
	            roomId:roomid,
	            liveId:'',
	            endTime:getLocalTime(new Date().getTime()),
	            liveflag:'2',
	            url:document.URL,
	        })
	   	}  
    })
    
</script>
<script type="text/javascript">
        var cameraList,
            microPhoneList,
            cameraOptions = '',
            microPhoneOptions = '';
        var publishBtn = document.getElementById('publishBtn');
        var previewBtn = document.getElementById('previewBtn')
        var testInput = document.getElementsByClassName('u-input');
        var myPublisher = new nePublisher('my-publisher', {
                //viewOptions
                videoWidth: 960,
                videoHeight: 540,
                fps: 20,
                bitrate: 1500
            }, {
                previewWindowWidth: $(".content-center").width(),
                previewWindowHeight: $(".content-center").height(),
                wmode: 'transparent',
                quality: 'high',
                allowScriptAccess: 'always'
            }, function() {
                cameraList = this.getCameraList();
                microPhoneList = this.getMicroPhoneList();
                console.log(cameraList, microPhoneList);
                for (var i = cameraList.length - 1; i >= 0; i--) {
                    cameraOptions = '<option value="' + i + '">' + cameraList[i] + '</option>' + cameraOptions;
                }
                for (var i = microPhoneList.length - 1; i >= 0; i--) {
                    microPhoneOptions = '<option value="' + i + '">' + microPhoneList[i] + '</option>' + microPhoneOptions;
                }
                document.getElementById("cameraSelect").innerHTML = cameraOptions;
                document.getElementById("microPhoneSelect").innerHTML = microPhoneOptions;
            }, function(code, desc) {
                console.log(code, desc);
            });
        var qualityList = [
            {
                //流畅
                fps: 20,
                bitrate: 600,
                videoWidth:480,
                videoHeight:360
            },
            {
                //标清
                fps: 20,
                bitrate: 800,
                videoWidth:640,
                videoHeight:480
            },
            {
                //高清
                fps: 20,
                bitrate: 1500,
                videoWidth:960,
                videoHeight:540
            }
        ];
        var getCameraIndex = function() {
            var cameraSelect = document.getElementById("cameraSelect");
            var cameraIndex = cameraSelect.selectedIndex;
            return cameraSelect.options[cameraIndex].value;
        };
        var getMicroPhoneIndex = function() {
            var microPhoneSelect = document.getElementById("microPhoneSelect");
            var microPhoneIndex = microPhoneSelect.selectedIndex;
            return microPhoneSelect.options[microPhoneIndex].value;
        };
        var getQualityOption = function() {
            var qualitySelect = document.getElementById("qualitySelect");
            var qualityIndex = qualitySelect.selectedIndex;
            return qualityList[qualityIndex];
        };
        var startPreview = function() {
            myPublisher.startPreview(getCameraIndex());
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
        };
        var startPublish = function() {
            var publishUrl = "rtmp://p9a6d110b.live.126.net/live/382830b04fe7421198f7902b979c327f?wsSecret=9583a1918b556481db896d7c73add3ae&wsTime=1559538578";
            startPublishCall();
            myPublisher.setCamera(getCameraIndex());
            myPublisher.setMicroPhone(getMicroPhoneIndex());
            myPublisher.startPublish(publishUrl, getQualityOption(),function(code, desc) {
                console.log(code, desc);
                alert(code + '：' + desc);
                stopPublishCall();
            });
        };
        var stopPublish = function() {
            myPublisher.stopPublish();
            stopPublishCall();
        };
        var startPublishCall = function() {
            console.log('推流开始');
            document.getElementsByClassName('u-status')[0].innerHTML = '直播中';
            publishBtn.innerHTML = '停止直播';
            publishBtn.onclick = stopPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = true;
            }
            previewBtn.disabled = true;

        };
        var stopPublishCall = function() {
            console.log('推流结束');
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
            publishBtn.innerHTML = '开始直播';
            publishBtn.onclick = startPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = false;
            }
            previewBtn.disabled = false;
        };
    </script>
</html>