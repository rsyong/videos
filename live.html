<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10" > 
    <link rel="stylesheet" href="static/css/buttons.css" />
    <link rel="stylesheet" href="static/css/video-js.min.css" />
    <link rel="stylesheet" href="static/css/app.css" />
    <script type="text/javascript" src="static/js/nePublisher.js" ></script>
	<script src="static/js/video.min.js"></script>
</head>

<body>
	<div style="position: absolute;z-index: -100;opacity: 0;">
	    <div class="m-input">
	        <span class="u-input-name">摄像头：</span>
	        <select class="u-input" id="cameraSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">麦克风：</span>
	        <select class="u-input" id="microPhoneSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">清晰度：</span>
	        <select class="u-input" id="qualitySelect">
	            <option value="0">流畅（480*360@20）</option>
	            <option value="1">标清（640*480@20）</option>
	            <option value="2">高清（960*540@20）</option>
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">推流地址：</span>
	        <input class="u-input" type="text" id="publishUrl" value="">
	    </div>
	    <div class="m-input">
	        <button class="button button-primary button-rounded testBtn" id="previewBtn" onclick="startPreview()">预览</button>
	        <!--<button class="button button-primary button-rounded testBtn" id="publishBtn" onclick="startPublish()">开始直播</button>-->
	        <span class="u-status"></span>
	    </div>
	    <div style="height: 1px;overflow: hidden;opacity: 0;">
	    	<!--<div id="my-publisher"></div>-->
	    </div>
    </div>
    <div class="main">
        <div class="flex just-between">
            <div class="gs-title">
                <span class="gs-live-in">直播未开始</span>
                <?=$userinfo['uid']?> 角色
                    <?=$userinfo['roleName']?>
            </div>
            <div class="color-fff" style="font-size: 14px;">欢迎您,
                <?=$userinfo['name']?>
            </div>
        </div>
        <div class="content flex">
            <div class="content-left">
                <div class="content-left-top back" data-src = "rtmp://no3.ybinu.cn:1935/hls/<?php echo $roomid?>">
                    <div id="my-publisher-all">
                		<div id="my-publisher"></div>
                	</div>
                    <!-- <img src="./img/doc_bg.png" style="width: 260px;"> -->
                    <div id="my-video-all" style="color:black;width:100%;height:100%">
                    	<video id="my-video" style="color:black;width:100%;height:100%" class="video-js vjs-big-play-centered" autoplay controls preload="auto" data-setup="{}">
							<source src="rtmp://no3.ybinu.cn:1935/hls/<?php echo $roomid?>" type="rtmp/flv">
							<!--<source src="rtmp://ns8.indexforce.com/home/mystream" type="rtmp/flv">-->
						</video>
                    </div>
                </div>
                <div class="content-left-top back mt-10">
                    <video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
						<source id="my-source" src="rtmp://v9a6d110b.live.126.net/live/382830b04fe7421198f7902b979c327f" type="rtmp/flv">
					</video>
					<?php $isIE = strpos($_SERVER['HTTP_USER_AGENT'],"Triden"); if(!$isIE){?>
					<embed width="300" height="70" class="openFlash" style="position:absolute;z-Index:9999;top:0;" type="application/x-shockwave-flash">
					<?php } ?>
					<div style="position: absolute;width: 100%;height: 100%;top: 0;left: 0;z-index: -10;" id="my-publisher2-all">
						<div id="my-publisher2"></div>
					</div>
                </div>
                <div class="content-left-bottom back mt-10 flex flex-column">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>在线学生列表</div>
                        </div>
                    </div>
                    <div class="flex1 subList-online">
                        <ul id="subList-online">
                            <!--<li class="flex just-between align-center">
                                <div class="flex1"><img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />asd</div>
                                <div>
                                	<div class="flex">
                                		<div class="sn-btn" title="禁言">禁言</div>
                                		<div class="sn-btn" title="踢出">踢出</div>
                                	</div>
                                </div>
                            </li>-->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex1 ml-10 flex flex-column">
                <div class="content-center back">
                	<div class="flex gs-userlist-count align-center">
                		<div class="count-list">白板</div>
                		<div class="count-list">分享屏幕</div>
                	</div>
                	<div style="height: calc(100% - 34px);" class="count-list-c">
                		<div id="wbord" style="height: 100%;width: 100%;background-color: #fff;"></div>
                	</div>
                	<div style="height: calc(100% - 34px);" class="count-list-c share">
                		<div style="height: 100%;width: 100%;background-color: #fff;">分析屏幕</div>
                	</div>
                </div>
                <div class="content-bottom back mt-10">
                	<div class="flex align-center content-bottom-center" style="height: 100%;padding: 0 1rem;">
                		<div id="publishBtn" class="content-bottom-list" onclick="startPublish()">开始直播</div>
                		<div id="begin" class="content-bottom-list">播放</div>
                		<div id="stop" class="content-bottom-list">暂停</div>
                		<div id="Offline" class="content-bottom-list">强制下线</div>
                		<div id="endclass" class="content-bottom-list">结束课程</div>
                		<div id="copy" class="content-bottom-list" onclick="startPublish()">复制地址</div>
                		<!--<div id="worklist" class="content-bottom-list">作业列表</div>-->
                		<a class="ation operation_raise2 back-img" href="javascript:;" id="worklist" title="作业列表"></a>
                		<a class="ation operation_raise back-img" href="javascript:;" id="hands" title="举手"></a>
                	</div>
                </div>
            </div>
            <div class="content-right back ml-10">
                <div class="flex flex-column" style="height: 100%;">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>聊天</div>
                            <div class="onlye">
                                <input class="my-checkbox" type="checkbox">只看我
                            </div>
                        </div>
                    </div>
                    <div class="flex stutent-list">
                        <ul id="subList"></ul>
                    </div>
                    <div class="color-fff quiz">
                       	 发表评论
                        <div style="margin-top: 10px;" class="flex just-between">
                            <textarea id="send" class="flex"></textarea>
                            <input class="btn" id="btn" type="button" value="发送">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input value="1" id="copyValue" style="opacity: 0;height: 0;width: 1px;" />
    </div>
    <input id="user_id" type="hidden" value="<?php echo $userinfo['uid']?>">
	<input id="roomid" type="hidden" value="<?php echo $roomid?>">
	<input id="roleName" type="hidden" value="<?php echo $userinfo['roleName']?>">
	<input id="tid" type="hidden" value="<?php echo $tid?>">
	<input id="roleCode" type="hidden" value="<?php echo $userinfo['roleCode']?>">
	<input id="liveid" type="hidden" value="<?php echo $liveid?>">
</body>
<script type="text/javascript" src="static/js/jquery.min.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/NIM_Web_NIM_v6.4.0.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/NIM_Web_WhiteBoard_v6.4.0.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/DrawPlugin.js" ></script>
<script type="text/javascript" src="static/js/md5.js" ></script>
<script type="text/javascript" src="static/js/ajax.js" ></script>
<script type="text/javascript" src="static/layerSDK/layer.js" ></script>
<script type="text/javascript" src="static/js/common.js" ></script>
<script type="text/javascript">
//	"username=350111201201101097; roleCode=Student; Token=716b545a"
    $(function() {
    	var username=getCookie("username");
        var roomid = $('#roomid').val(); //房间号
        var userid = $('#user_id').val();//学生id
        var techerid=$('#tid').val();//教师id
        var isRoleName=$('#roleName').val()=='教师'; //角色是否是教师
        var roleCode=$('#roleCode').val();
        var liveid=$('#liveid').val();
        var isBottom = true; //是否刷新到底部
        var times = '',timesS=''; //计时器
        var iswords=false;//禁言
        var isKickout=false;//提出房间
        if(isRoleName){
        	$("#my-video-all").remove();
        	$("#copy").hide();
        	$("#worklist").hide();
        	$(".ation").hide();
        	$("#begin").hide();
        	$("#stop").hide();
        }else{
        	$("#my-publisher-all").remove();
        	$("#publishBtn").hide();
        	$("#Offline").hide();
        	$("#endclass").hide();
        	$("#begin").hide();
        	$("#stop").hide();
        }
        fetch(); //初始化聊天列表
        fetchStuent(); //初始化学生直播窗口
        $("#copyValue").val("rtmp://no3.ybinu.cn:1935/hls/"+userid);
        function fetch() {
            var checkboxs = $(".my-checkbox")[0].checked;
            var obj = {},myurl='chatContent';
            if (checkboxs) {
            	obj = {
                    sid: userid,
                    tid:techerid,
                    roomid:roomid
                }
            	myurl='showchat';
            } else {
                obj = {
                    roomid: roomid
                }
            }
            $.get(API + myurl, obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '';
                res.data&&res.data.forEach(function(item) {
                    html += '<li class="flex">'
								+'<div>'
									+'<img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png"  style="width: 40px;"/>'
								+'</div>'
								+'<div>'
									+'<div class="title">'+item.chatname+' ['+getLocalTime(item.ctime)+']</div>';
					if(item.chatcontent=='「举手」'){
						html+='<div class="title_content cur-pointer" data-id="'+item.chatuserid+'">'+item.chatcontent+'</div>'
					}else{
						html+='<div class="title_content">'+item.chatcontent+'</div>'
					}
								+'</div>'
							+'</li>'
                })
                $("#subList").html(html);
                if(isRoleName){
                	$(".cur-pointer").on("click",function(){
	                	changeStu($(this).attr("data-id"))
	                })
                }
                if (isBottom) {
                    $(".stutent-list").animate({
                        scrollTop: $(".stutent-list")[0].scrollHeight
                    }, 400);
                    isBottom = false;
                } else {
                    var sLT = $(".stutent-list")[0].scrollTop;
                    var sLSH = $(".stutent-list")[0].scrollHeight;
                    var sLH = $(".stutent-list").height();
                    if (sLT > sLSH - sLH) {
                        $(".stutent-list").animate({
                            scrollTop: sLSH
                        }, 400);
                    };
                }
                times = setTimeout(function() {
                    fetch();
                }, 6000)
            })
        }
        //学生窗口
        var fetchStuentUrl='';
        function fetchStuent() {
            $.get(API + "getstuadr", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.url) {
                	if(fetchStuentUrl!=res.url){
                		if(res.url==userid){
	                		layer.confirm('是否开始直播？', {
							  	btn: ['确定','取消'] //按钮
							}, function(){
							  	$("#publishBtn").click();
							  	layer.closeAll();
							  	$("#begin").show();
        						$("#stop").show();
							  	$("#my-publisher2-all").css("z-index","100")
							}, function(){
							  
							});
	                	}else{
	                		changeSrc("rtmp://no3.ybinu.cn:1935/hls/"+res.url);
	                		$("#my-publisher2-all").css("z-index","-100");
	                		if(fetchStuentUrl!=''){stopPublish()}
	                		$("#begin").hide();
        					$("#stop").hide();
	                	}
	                	fetchStuentUrl=res.url;
                	}
                }
                timesS=setTimeout(function() {
                    fetchStuent();
                }, 10000)
            })
            $.get(API + "getuseronline", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = "";
                res.data&&res.data.forEach(function(item) {
                	if(item.uid==userid){
                		if(item.status.indexOf("1")>-1){
                			iswords=true;
                		}
                		if(item.status.indexOf("2")>-1){
                			location.reload()
                		}
                	}
                	html+='<li class="flex just-between align-center" data-id="'+item.uid+'">'
                                +'<div class="flex1"><img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />'+item.name+'</div>'
                                +'<div>'
                                	+'<div class="flex">'
                                		+'<div class="sn-btn" title="禁言" data-status="1">禁言</div>'
                                		+'<div class="sn-btn" title="踢出" data-status="2">踢出</div>'
                                	+'</div>'
                                +'</div>'
                            +'</li>';
                })

				$.get("http://lyg.goluckin.com/index.php/userstatus/useronline", {
                	roomid: roomid
            	})
                $("#subList-online").html(html);
                if(isRoleName){
                	$("#subList-online li").on("click", function(e) {
                		e.stopPropagation();
	                    changeStu($(this).attr("data-id"))
	                })
                	$(".sn-btn").on("click", function(e) {
                		e.stopPropagation();
	                    changeStuStatus($(this).attr("data-status"),$(this).closest(".align-center").attr("data-id"))
	                })
                }
            })
        }
        //监听切换私聊
        $(".my-checkbox").on("change",function(){
        	isBottom=true;
        	clearTimeout(times);
           	fetch();
        })
        //监听发送回车
        $("#send").on('keydown', function(e) {
            if (e.keyCode != 13) {
                return;
            } else { //当按键输入为回车时，执行下列操作
                event.preventDefault(); //为了兼容IE8
                e.returnValue = false;
                send();
            }
        });
        //发送按钮
        $("#btn").on("click", function() {
            send();
        })
        $("#hands").on("click",function(){
        	$.get(API + "sendmsg", {
        		roomid: roomid,
                userid: userid,
                content: '「举手」'
        	}, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    layer.msg(res.msg);
                    return;
                }
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        })
        //发送消息
        function send() {
        	if(iswords) {
        		layer.msg("你已被禁言");
        		return;
        	}
        	if(isKickout) {
        		layer.msg("你已被踢出房间");
        		return;
        	}
            var sendVal = $("#send").val();
            if (sendVal == '') {
                layer.msg("发送不能为空！")
                return;
            }
            var checkboxs = $(".my-checkbox")[0].checked,
                obj = {};
            obj = {
                roomid: roomid,
                userid: userid,
                content: sendVal
            }
            if (checkboxs) {
                obj.touser = userid;
            }
            $.get(API + "sendmsg", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    layer.msg(res.msg);
                    return;
                }
                $("#send").val('');
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        }
		//改变路径
        function changeSrc(src) {
        	var videoPlayer = $("#my-video2").get(0);
        	if (typeof (videoPlayer) != "undefined") {
        		var myPlayer = videojs('my-video2');
        		myPlayer.dispose();
        		var id="my-video2";
        		var htmls='<video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">'
							+'<source id="my-source" src='+src+' type="rtmp/flv">'
						+'</video>'
        		$(".content-left-top").html(htmls);
	            //设置资源路径
	            $(".content-left-top").attr("src", src);
	            videojs(id, {}, function () { //自动播放
	                // Player (this) is initialized and ready.
	                var myPlayer = videojs(id);
	                videojs(id).ready(function () {
	                    var myPlayer2 = this;
	                    myPlayer2.play();
	                });
	            });
        	}
	    }
        //停止播放
        $("#stop").on("click",function(){
        	var myPlayera = videojs("my-video2");
        	myPlayera.pause();
        	$(".content-left-models").show();
        })
        //开始播放
        $("#begin").on("click",function(){
        	var myPlayera = videojs("my-video2");
        	myPlayera.load();
        	$(".content-left-models").hide();
        })
        //改变学生窗口播放源
        function changeStu(id){
        	$.get(API + "setstuadr", {
                roomid: roomid,
                stuid:id
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                layer.msg("切换成功");
            })
        }
        function changeStuStatus(status,uid){
        	$.get(API + "chataudit", {
                userid: uid,
                status:status,
                roomid:roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                layer.msg(res.msg);
            })
        }
        //复制源地址
        $("#copy").on("click",function(){
        	$("#copyValue")[0].select();
        	document.execCommand("Copy");
        	layer.msg("复制成功");
        })
        //作业列表
        $("#worklist").on("click",function(){
        	$.get(API + "teacher_homework_list", {
                liveid: liveid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '<ul class="material">';
                res.data&&res.data.forEach(function(item) {
                    html += '<li class="flex just-between">'
				                +'<div>'+item.clName+'</div>'
				                +'<a href="'+item.path+'" target="_blank" class="material_btn">下载</a>'
				            +'</li>'
                })
                html+='</ul>';
                layer.open({
				  title: '作业列表',
					  area:['500px','auto'],
					  btn:[],
					  content: html
				}); 
            })
        })
        $("#Offline").on("click",function(){
        	changeStu("123456")
        })
        $("#endclass").on("click",function(){
        	onunload_handler();
        })
        $(".count-list").on("click",function(){
        	$(".count-list-c").eq($(this).index()).show().siblings(".count-list-c").hide();
        })
        window.onunload = onunload_handler; 
	    function onunload_handler(){
	        $.get(API+"endClasses", {
	            userId: userid,
	            roleCode:roleCode,
	            roomId:roomid,
	            liveId:liveid,
	            endTime:getLocalTime(new Date().getTime()),
	            liveflag:'2',
	            url:document.URL,
	        }).then(function(res){
	        	typeof res == "string" && (res = JSON.parse(res));
	        	layer.msg("结束成功");
	        })
	   	}
	    //白板模块
	    if(!username) return alert("未登录");
	    var nim=wb=drawPlugin='',appkey='1ee5a51b7d008254cd73b1d4369a9494';
	    var wbAPI='https://app.netease.im/api';
	    var ISStudent=getCookie("roleCode")=="Student";
	    //登录IM
	    login(username,MD5('123456'));
	    
	    function login(account, token){
			NIM.use(WhiteBoard)
			nim = window.NIM.getInstance({
				debug: false,
		        appKey: appkey,
		        account:account,
		        token:token,
		        db: false,
		        syncSessionUnread: true,
		        syncRobots: true,
		        autoMarkRead: true, // 默认为true
		        ondisconnect:function (event) {
		        	if(event.code=="302"){
		        		regiset(account,token);
		        	}
		        },
		        onconnect: function(event) {
		          console.log(JSON.stringify(event)+"im连接成功....");
		          if(localStorage.roomid){
		          	initWB()
		          }else{
		          	if(ISStudent){
			          	layer.prompt({title: '请输入白板房间ID', formType: 0}, function(text, index){
			          	    if (!/^[0-9]{8,9}$/.test(text)) {
				                layer.msg('房间ID不存在');
				                return;
				            }
						    layer.close(index);
						    localStorage.roomid=text;
						    initWB()
						});
			        }else{
			        	initFetch(account);
			        }
		          }
		        }
			})
		}
	    function joinChannelWb(roomId){
	    	if (!wb) return alert('wb::没有实例化');
			wb.joinChannel({
	        	channelName: roomId
        	}).then(res=>{
        		console.log(res,11)
        	}).catch(err=>{
        		console.log(err,22)
//      		if(isTeacher==1) return;
				if(ISStudent) return layer.msg('加入房间失败');;
        		wb.createChannel({
		            channelName: roomId
		        }).then(res=>{
		        	console.log(res)
		        }).catch(err=>{
		        	console.log(err)
		        })
        	})
	    }
	    function initWB(){
	    	wb = WhiteBoard.getInstance({
				nim:nim,
				debug:true
			})
	    	drawPlugin = new DrawPlugin(document.getElementById("wbord"), {
			  UID: wb.getAccount(),
			  nim: nim  // nim实例
			})
	    	
	    	joinChannelWb(localStorage.roomid); //加入白板房间
	    	
	    	drawPlugin.enableDraw(!ISStudent); //是否可以操作白板
	    	
			drawPlugin.on('data', (obj) => {
			  let { toAccount = 0, data } = obj
			  wb.sendData({ toAccount, data })
			})
			
			wb.on('data', (obj) => {
			  drawPlugin.act({ account: obj.account, data: obj.data })
			});
	    }
	    function initFetch(account){
	    	ajax({
          		type:"POST",
          		url:wbAPI+"/chatroom/create",
          		dataType: "json",
          		data:{
          			creator: account,
			        name: "zhibo"
          		}
          	}).then(res=>{
          		let roomid=res.msg;
		        localStorage.roomid=roomid;
          	}).catch(err=>{
          		ajax({
          			type:"POST",
	          		url:wbAPI+"/chatroom/getAddress",
	          		dataType: "form",
	          		data:{
	          			uid: account,
					    roomid: roomid
	          		}
          		}).then(res=>{
          			localStorage.roomMsg=JSON.stringify(res.msg);
          			initWB();
          		})
          	})
	    }
	    function regiset(account,token){
	    	ajax({
          		type:"POST",
          		url:wbAPI+"/createDemoUser",
          		dataType: "form",
          		headers:{
					appkey:appkey
				},
          		data:{
          			username: account,
				    nickname:'lyg'+account.substring(account.length-7),
				    password: token
          		}
          	}).then(res=>{
          		if(res.res==200){
          			login(account,token);
          		}
          	}).catch(err=>{
          		alert("注册出错！");
          	})
	    }
    })
</script>
<script type="text/javascript">
	var isRoleName=$('#roleName').val()=='教师'; //角色是否是教师
	var userid = $('#user_id').val();//学生id
	var roomid = $('#roomid').val(); //房间号
	
        var cameraList,
            microPhoneList,
            cameraOptions = '',
            microPhoneOptions = '';
        var publishBtn = document.getElementById('publishBtn');
        var previewBtn = document.getElementById('previewBtn')
        var testInput = document.getElementsByClassName('u-input');
        var ids='my-publisher2',mClass='.content-left-top';
        if(isRoleName){
        	ids='my-publisher';
        	mClass='.content-center';
        }
        var myPublisher = new nePublisher(ids, {
            //viewOptions
            videoWidth: 960,
            videoHeight: 540,
            fps: 20,
            bitrate: 1500
        }, {
            //flashOptions
            previewWindowWidth: $(mClass).width(),
            previewWindowHeight: $(mClass).height(),
            wmode: 'transparent',
            quality: 'high',
            allowScriptAccess: 'always'
        }, function() {
            cameraList = this.getCameraList();
            microPhoneList = this.getMicroPhoneList();
            console.log(cameraList, microPhoneList);
            for (var i = cameraList.length - 1; i >= 0; i--) {
                cameraOptions = '<option value="' + i + '">' + cameraList[i] + '</option>' + cameraOptions;
            }
            for (var i = microPhoneList.length - 1; i >= 0; i--) {
                microPhoneOptions = '<option value="' + i + '">' + microPhoneList[i] + '</option>' + microPhoneOptions;
            }
            document.getElementById("cameraSelect").innerHTML = cameraOptions;
            document.getElementById("microPhoneSelect").innerHTML = microPhoneOptions;
            
        }, function(code, desc) {
            console.log(code, desc);
            
        });
        var qualityList = [
            {
                //流畅
                fps: 20,
                bitrate: 600,
                videoWidth:480,
                videoHeight:360
            },
            {
                //标清
                fps: 20,
                bitrate: 800,
                videoWidth:640,
                videoHeight:480
            },
            {
                //高清
                fps: 20,
                bitrate: 1500,
                videoWidth:960,
                videoHeight:540
            }
        ];
        var getCameraIndex = function() {
            var cameraSelect = document.getElementById("cameraSelect");
            var cameraIndex = cameraSelect.selectedIndex;
            return cameraSelect.options[cameraIndex].value;
        };
        var getMicroPhoneIndex = function() {
            var microPhoneSelect = document.getElementById("microPhoneSelect");
            var microPhoneIndex = microPhoneSelect.selectedIndex;
            return microPhoneSelect.options[microPhoneIndex].value;
        };
        var getQualityOption = function() {
            var qualitySelect = document.getElementById("qualitySelect");
            var qualityIndex = qualitySelect.selectedIndex;
            return qualityList[qualityIndex];
        };
        var startPreview = function() {
            myPublisher.startPreview(getCameraIndex());
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
        };
        var startPublish = function() {
            var publishUrl = "rtmp://no3.ybinu.cn:1935/hls/"+(isRoleName==true ? roomid : userid);
            startPublishCall();
            myPublisher.setCamera(getCameraIndex());
            myPublisher.setMicroPhone(getMicroPhoneIndex());
            myPublisher.startPublish(publishUrl, getQualityOption(),function(code, desc) {
                console.log(code, desc);
                alert(code + '：' + desc);
                stopPublishCall();
            });
        };
        var stopPublish = function() {
            myPublisher.stopPublish();
            stopPublishCall();
        };
        var startPublishCall = function() {
            console.log('推流开始');
            document.getElementsByClassName('u-status')[0].innerHTML = '直播中';
            publishBtn.innerHTML = '停止直播';
            publishBtn.onclick = stopPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = true;
            }
            previewBtn.disabled = true;

        };
        var stopPublishCall = function() {
            console.log('推流结束');
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
            publishBtn.innerHTML = '开始直播';
            publishBtn.onclick = startPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = false;
            }
            previewBtn.disabled = false;
        };
    </script>
</html>