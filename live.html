<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="//vjs.zencdn.net/5.19/video-js.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" href="css/app.css" />-->
    <link rel="stylesheet" href="http://lyg.goluckin.com/themes/css/app.css" />
	<script src="http://gz.ybinu.cn/video5.18/js/video.min.js"></script>
</head>

<body>
    <div class="main">
        <div class="flex just-between">
            <div class="gs-title">
                <span class="gs-live-in">直播未开始</span>
                <?=$userinfo['uid']?> 角色
                    <?=$userinfo['roleName']?>
            </div>
            <div class="color-fff" style="font-size: 14px;">欢迎您,
                <?=$userinfo['name']?>
            </div>
        </div>
        <div class="content flex">
            <div class="content-left">
                <div class="content-left-top back">
                    <video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
						<source id="my-source" src="rtmp://no3.ybinu.cn:1935/hls/0" type="rtmp/flv">
						<!--<source src="rtmp://ns8.indexforce.com/home/mystream" type="rtmp/flv">-->
					</video>
                </div>
                <div class="content-left-bottom back mt-10 flex flex-column">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>在线学生列表</div>
                        </div>
                    </div>
                    <div class="flex1 subList-online">
                        <ul id="subList-online">
                            <!--<li class="flex just-between align-center">
                                <div><img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />asd</div>
                                <div class="online-btn">
                                	<input value="sa" />
                                	复制
                                </div>
                            </li>-->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex1 ml-10 flex flex-column">
                <div class="content-center back flex just-center align-center" data-src = "rtmp://no3.ybinu.cn:1935/hls/<?php echo $roomid?>">
                    <!-- <img src="./img/doc_bg.png" style="width: 260px;"> -->
                    <video id="my-video" style="color:black;width:100%;height:100%" class="video-js vjs-big-play-centered" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
							<source src="rtmp://no3.ybinu.cn:1935/hls/<?php echo $roomid?>" type="rtmp/flv">
							<!--<source src="rtmp://ns8.indexforce.com/home/mystream" type="rtmp/flv">-->
						</video>
                    <embed width="300" height="70" class="openFlash" style="position:absolute;z-Index:9999;" type="application/x-shockwave-flash">
                </div>
                <div class="content-bottom back mt-10">
                	<div class="flex align-center" style="height: 100%;padding: 0 1rem;">
                		<div id="worklist">作业列表</div>
                	</div>
                </div>
            </div>
            <div class="content-right back ml-10">
                <div class="flex flex-column" style="height: 100%;">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>聊天</div>
                            <div class="onlye">
                                <input class="my-checkbox" type="checkbox">只看我
                            </div>
                        </div>
                    </div>
                    <div class="flex stutent-list">
                        <ul id="subList"></ul>
                    </div>
                    <div class="color-fff quiz">
                       	 发表评论
                        <div style="margin-top: 10px;" class="flex just-between">
                            <textarea id="send" class="flex"></textarea>
                            <input class="btn" id="btn" type="button" value="发送">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="stop">停止</button>
        <button id="begin">开始</button>
        <button id="copy">复制地址</button>
        <input value="1" id="copyValue" style="opacity: 0;height: 0;width: 1px;" />
    </div>
   </div>
    <input id="user_id" type="hidden" value="<?php echo $userinfo['uid']?>">
	<input id="roomid" type="hidden" value="<?php echo $roomid?>">
	<input id="roleName" type="hidden" value="<?php echo $userinfo['roleName']?>">
<input id="tid" type="hidden" value="<?php echo $tid?>">
</body>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="http://lyg.goluckin.com/themes/js/layer.js" ></script>
<script type="text/javascript" src="http://lyg.goluckin.com/themes/js/common.js" ></script>
<!--<script type="text/javascript" src="js/common.js"></script>-->
<script type="text/javascript">
    $(function() {
        var roomid = $('#roomid').val(); //房间号
        var userid = $('#user_id').val();//学生id
        var techerid=$('#tid').val();//教师id
		var liveid="999e4ee805745a5a3322916203384930";
        var isRoleName=$('#roleName').val()=='教师'; //角色是否是教师
        var isBottom = true; //是否刷新到底部
        var times = '',timesS=''; //计时器
        fetch(); //初始化聊天列表
        fetchStuent(); //初始化学生直播窗口
        $("#copyValue").val("rtmp://no3.ybinu.cn:1935/hls/"+userid);
        if(isRoleName){
        	$(".onlye").hide();
        }
        function fetch() {
            var checkboxs = $(".my-checkbox")[0].checked;
            var obj = {};
            if (checkboxs) {
            	obj = {
            		roomid: roomid,
                    userid: userid
//                  sid: userid,
//                  tid:techerid,
//                  roomid:roomid
                }
            } else {
                obj = {
                    roomid: roomid
                }
            }
            $.get(API + "chatContent", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '';
                res.data&&res.data.forEach(function(item) {
                    html += `<li class="flex">
								<div>
									<img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png"  style="width: 40px;"/>
								</div>
								<div>
									<div class="title">${item.chatname} [${getLocalTime(item.ctime)}]</div>
									<div class="title_content">${item.chatcontent}</div>
								</div>
							</li>`
                })
                $("#subList").html(html);
                if (isBottom) {
                    $(".stutent-list").animate({
                        scrollTop: $(".stutent-list")[0].scrollHeight
                    }, 400);
                    isBottom = false;
                } else {
                    var sLT = $(".stutent-list")[0].scrollTop;
                    var sLSH = $(".stutent-list")[0].scrollHeight;
                    var sLH = $(".stutent-list").height();
                    if (sLT > sLSH - sLH) {
                        $(".stutent-list").animate({
                            scrollTop: sLSH
                        }, 400);
                    };
                }
                times = setTimeout(function() {
                    fetch();
                }, 6000)
            })
        }
        //学生窗口
        var fetchStuentUrl='';
        function fetchStuent() {
            $.get(API + "getstuadr", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.url) {
                	if(fetchStuentUrl!=res.url){
                		fetchStuentUrl=res.url;
                		changeSrc(res.url);
                	}
                }
                timesS=setTimeout(function() {
                    fetchStuent();
                }, 10000)
            })
            $.get(API + "getuseronline", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = "";
                res.data&&res.data.forEach(function(item) {
					html+=`<li data-id="${item.uid}">
                                <img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />${item.name}
                            </li>`
                })

				$.get("http://lyg.goluckin.com/index.php/userstatus/useronline", {
                	roomid: roomid
            	})
                $("#subList-online").html(html);
                if(isRoleName){
                	$("#subList-online li").on("click", function() {
	                    changeStu($(this).attr("data-id"))
	                })
                }
            })
        }
        //监听切换私聊
        $(".my-checkbox").on("change",function(){
        	isBottom=true;
        })
        //监听发送回车
        $("#send").on('keydown', function(e) {
            if (e.keyCode != 13) {
                return;
            } else { //当按键输入为回车时，执行下列操作
                event.preventDefault(); //为了兼容IE8
                e.returnValue = false;
                send();
            }
        });
        //发送按钮
        $("#btn").on("click", function() {
            send();
        })
        //发送消息
        function send() {
            var sendVal = $("#send").val();
            if (sendVal == '') {
                layer.msg("发送不能为空！")
                return;
            }
            var checkboxs = $(".my-checkbox")[0].checked,
                obj = {};
            obj = {
                roomid: roomid,
                userid: userid,
                content: sendVal
            }
            if (checkboxs) {
                obj.touser = userid;
            }
            $.get(API + "sendmsg", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    layer.msg(res.msg);
                    return;
                }
                $("#send").val('');
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        }
		//改变路径
        function changeSrc(src) {
        	var videoPlayer = $("#my-video2").get(0);
        	if (typeof (videoPlayer) != "undefined") {
        		var myPlayer = videojs('my-video2');
        		myPlayer.dispose();
        		var id="my-video2";
        		$(".content-left-top").html(`<video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" autoplay controls preload="auto" width="750" height="350" data-setup="{}">
							<source id="my-source" src="${src}" type="rtmp/flv">
						</video>`);
	            //设置资源路径
	            $(".content-left-top").attr("src", src);
	            videojs(id, {}, function () { //自动播放
	                // Player (this) is initialized and ready.
	                var myPlayer = videojs(id);
	                videojs(id).ready(function () {
	                    var myPlayer2 = this;
	                    myPlayer2.play();
	                });
	            });
        	}
	    }
        //停止播放
        $("#stop").on("click",function(){
        	var myPlayera = videojs("my-video2");
        	myPlayera.pause();
        	$(".content-left-models").show();
        })
        //开始播放
        $("#begin").on("click",function(){
        	var myPlayera = videojs("my-video2");
        	myPlayera.load();
        	$(".content-left-models").hide();
        })
        //改变学生窗口播放源
        function changeStu(id){
        	$.get(API + "setstuadr", {
                roomid: roomid,
                stuid:id
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                clearTimeout(timesS);
                fetchStuent();
                layer.msg("切换成功");
            })
        }
        //复制源地址
        $("#copy").on("click",function(){
        	$("#copyValue")[0].select();
        	document.execCommand("Copy");
        	layer.msg("复制成功");
        })
        //作业列表
        $("#worklist").on("click",function(){
        	$.get(API + "teacher_homework_list", {
                liveid: liveid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '<ul class="material">';
                res.data&&res.data.forEach(function(item) {
                    html += `<li class="flex just-between">
				                <div>${item.clName}</div>
				                <a href="${item.path}" target="_blank" class="material_btn">下载</a>
				            </li>`
                })
                html+='</ul>';
                layer.open({
				  title: '作业列表',
					  area:['500px','auto'],
					  btn:[],
					  content: html
				}); 
            })
        })
        //开始上课
        $.get("http://www.xueerqin.net:9526/cloud/api/beginClasses", {
            roomid: roomid
        }, function(res) {
            typeof res == "string" && (res = JSON.parse(res));
        })
        window.onunload = onunload_handler; 
	    function onunload_handler(){
	        $.get("http://www.xueerqin.net:9526/cloud/api/endClasses", {
	            userId: userid,
	            roleCode:'',
	            roomId:roomid,
	            liveId:liveid,
	            endTime:getLocalTime(new Date().getTime()),
	            liveflag:'2',
	            url:document.URL,
	        })
	   	} 
    })
</script>

</html>