<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>云上课堂</title>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE10" > 
    <link href="https://www.xueerqin.net/Images/logo.ico" rel="Shortcut Icon" type="text/css">
    <link rel="stylesheet" href="/themes/static/css/buttons.css" />
    <link rel="stylesheet" href="/themes/static/css/video-js.min.css" />
    <link rel="stylesheet" href="/themes/static/css/app.css" />
    <script type="text/javascript" src="/themes/static/js/nePublisher.js" ></script>
	<script src="/themes/static/js/video.min.js"></script>
	<!--<link rel="stylesheet" href="static/css/buttons.css" />
    <link rel="stylesheet" href="static/css/video-js.min.css" />
    <link rel="stylesheet" href="static/css/app.css" />
    <script type="text/javascript" src="static/js/nePublisher.js" ></script>
	<script src="static/js/video.min.js"></script>-->
</head>

<body>
	<div style="position: absolute;z-index: -100;opacity: 0;">
	    <div class="m-input">
	        <span class="u-input-name">摄像头：</span>
	        <select class="u-input" id="cameraSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">麦克风：</span>
	        <select class="u-input" id="microPhoneSelect">
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">清晰度：</span>
	        <select class="u-input" id="qualitySelect">
	            <option value="0">流畅（480*360@20）</option>
	            <option value="1">标清（640*480@20）</option>
	            <option value="2">高清（960*540@20）</option>
	        </select>
	    </div>
	    <div class="m-input">
	        <span class="u-input-name">推流地址：</span>
	        <input class="u-input" type="text" id="publishUrl" value="">
	    </div>
	    <div class="m-input">
	        <button class="button button-primary button-rounded testBtn" id="previewBtn" onclick="startPreview()">预览</button>
	        <!--<button class="button button-primary button-rounded testBtn" id="publishBtn" onclick="startPublish()">开始直播</button>-->
	        <span class="u-status"></span>
	    </div>
	    <div style="height: 1px;overflow: hidden;opacity: 0;">
	    	<!--<div id="my-publisher"></div>-->
	    </div>
    </div>
    <div class="main">
        <div class="flex just-between">
            <div class="gs-title">
                <!--<span class="gs-live-in">未直播</span>-->
                <?=$userinfo['uid']?> 角色
                    <?=$userinfo['roleName']?>
            </div>
            <div class="color-fff" style="font-size: 14px;">欢迎您,
                <?=$userinfo['name']?>
            </div>
        </div>
        <div class="content flex">
            <div class="content-left">
                <div class="content-left-top content-left-top1 back" data-src = "rtmp://streamsrv.xueerqin.net/hls/<?php echo $roomid?>">
                    <div id="my-publisher-all">
                		<div id="my-publisher"></div>
                	</div>
                    <!-- <img src="./img/doc_bg.png" style="width: 260px;"> -->
                    <div id="my-video-all" style="color:black;width:100%;height:100%">
                    	<video id="my-video" style="color:black;width:100%;height:100%" class="video-js vjs-big-play-centered" autoplay controls preload="auto" data-setup="{}">
							<source src="rtmp://streamsrv.xueerqin.net/hls/<?php echo $roomid?>" type="rtmp/flv">
						</video>
                    </div>
                </div>
                <div class="content-left-top content-left-top2 back mt-10">
                	<div class="sudent-video" style="height: 100%;">
                		
                	</div>
                    <!--<video id="my-video2" style="color:black;width:100%;height:100%" class="video-js" controls preload="auto" width="750" height="350">
						<source id="my-source" src="rtmp://v9a6d110b.live.126.net/live/382830b04fe7421198f7902b979c327f" type="rtmp/flv">
					</video>-->
					<?php $isIE = strpos($_SERVER['HTTP_USER_AGENT'],"Triden"); if(!$isIE){?>
					<embed width="300" height="70" class="openFlash" style="position:absolute;z-Index:9999;top:0;" type="application/x-shockwave-flash">
					<?php } ?>
					<div style="position: absolute;width: 100%;height: 100%;top: 0;left: 0;z-index: 0;" id="my-publisher2-all">
						<div id="my-publisher2"></div>
					</div>
                </div>
                <div class="content-left-bottom back mt-10 flex flex-column">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>在线学生列表</div>
                        </div>
                    </div>
                    <div class="flex1 subList-online">
                        <ul id="subList-online">
                            <!--<li class="flex just-between align-center">
                                <div class="flex1"><img src="http://lyg.goluckin.com/themes/v2/static/images/17yk.png" />asd</div>
                                <div>
                                	<div class="flex">
                                		<div class="sn-btn" title="禁言">禁言</div>
                                		<div class="sn-btn" title="踢出">踢出</div>
                                	</div>
                                </div>
                            </li>-->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex1 ml-10 flex flex-column">
                <div class="content-center back">
                	<div class="flex gs-userlist-count align-center">
                		<div class="count-list">白板</div>
                		<!--<div class="count-list count-list-top">分享屏幕</div>-->
                		<div style="position: relative;" class="count-list-top">
                			<div class="count-list">上传文件</div>
                			<input  id="file_ppt" style="position: absolute;top: 0;left: 0;width: 100%;height: 20px;opacity: 0;" type="file" accept=".pdf,.ppt,.pptx"/>
                		</div>
                		<div class="count-list-top">
                			<button class="count-list" id="getFliles">课件列表</button>
                		</div>
                	</div>
                	<div style="height: calc(100% - 34px);" class="count-list-c">
                		<div id="wbord" style="height: 100%;width: 100%;background-color: #fff;"></div>
                		<div class="wbord-control flex align-center just-center">
                			<div id="prevpages" class="content-bottom-list c-list-hide">上一页</div>
                			<div id="page-num" class="content-bottom-list c-list-hide">0/0</div>
	                		<div id="nextspages" class="content-bottom-list c-list-hide">下一页</div>
	                		<div id="clearFile" class="content-bottom-list c-list-hide">关闭文档</div>
	                		<div id="Revoke" class="content-bottom-list s-list-hide">撤销</div>
	                		<div id="wb_clear" class="content-bottom-list s-list-hide">清空</div>
                		</div>
                	</div>
                	<div style="height: calc(100% - 34px);" class="count-list-c share">
                		<div style="height: 100%;width: 100%;background-color: #fff;">
                			<div class="count-list" id="share_now" style="display: inline-block;margin: 15px;">分析当前屏幕</div>
                		</div>
                	</div>
                </div>
                <div class="content-bottom back mt-10">
                	<div class="flex align-center content-bottom-center" style="height: 100%;padding: 0 1rem;">
                		<div id="publishBtn" class="content-bottom-list" onclick="startPublish()">开始直播</div>
                		<!--<div id="begin" class="content-bottom-list">播放</div>-->
                		<div id="Offline" class="content-bottom-list">强制下线</div>
                		<div id="endclass" class="content-bottom-list">结束课程</div>
                		<!--<div id="copy" class="content-bottom-list">复制地址</div>-->
                		<!--<div id="worklist" class="content-bottom-list">作业列表</div>-->
                		<!--<a class="ation operation_raise2 back-img" href="javascript:;" id="worklist" title="作业列表"></a>-->
                		<!--<div id="endhudong" style="display: none;" class="content-bottom-list">取消互动</div>-->
                		<!--<div id="hudong" class="content-bottom-list">互动</div>-->
                		<a class="ation operation_raise back-img" href="javascript:;" id="hands" title="举手"></a>
                		<a class="content-bottom-list admins" href="http://lyg.goluckin.com/index.php/admin/login?token=<?php echo $userinfo['token']?>&roleCode=Teacher" target="_blank"  title="后台管理系统">后台管理系统</a>
                	</div>
                </div>
            </div>
            <div class="content-right back ml-10">
                <div class="flex flex-column" style="height: 100%;">
                    <div>
                        <div class="flex just-between gs-userlist-count color-fff">
                            <div>聊天</div>
                            <div class="onlye">
                                <input class="my-checkbox" type="checkbox">只看我
                            </div>
                        </div>
                    </div>
                    <div class="flex stutent-list">
                        <ul id="subList"></ul>
                    </div>
                    <div class="color-fff quiz">
                       	 发表评论
                        <div style="margin-top: 10px;" class="flex just-between">
                            <textarea id="send" class="flex"></textarea>
                            <input class="btn" id="btn" type="button" value="发送">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input value="1" id="copyValue" style="opacity: 0;height: 0;width: 1px;" />
    </div>
    <input id="user_id" type="hidden" value="<?php echo $userinfo['uid']?>">
	<input id="roomid" type="hidden" value="<?php echo $roomid?>">
	<input id="roleName" type="hidden" value="<?php echo $userinfo['roleName']?>">
	<input id="Name" type="hidden" value="<?php echo $userinfo['name']?>">
	<input id="tid" type="hidden" value="<?php echo $tid?>">
	<input id="roleCode" type="hidden" value="<?php echo $userinfo['roleCode']?>">
	<input id="liveid" type="hidden" value="<?php echo $liveid?>">
</body>
<script type="text/javascript" src="/themes/static/js/jquery.min.js" ></script>
<script type="text/javascript" src="/themes/static/WhiteBoardSDK/NIM_Web_NIM_v6.4.0.js" ></script>
<script type="text/javascript" src="/themes/static/WhiteBoardSDK/NIM_Web_WhiteBoard_v6.4.0.js" ></script>
<script type="text/javascript" src="/themes/static/WhiteBoardSDK/DrawPlugin.js" ></script>
<script type="text/javascript" src="/themes/static/js/md5.js" ></script>
<script type="text/javascript" src="/themes/static/js/ajax.js" ></script>
<script type="text/javascript" src="/themes/static/layerSDK/layer.js" ></script>
<script type="text/javascript" src="/themes/static/js/common.js?v=1.1" ></script>
<!--<script type="text/javascript" src="static/js/jquery.min.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/NIM_Web_NIM_v6.4.0.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/NIM_Web_WhiteBoard_v6.4.0.js" ></script>
<script type="text/javascript" src="static/WhiteBoardSDK/DrawPlugin.js" ></script>
<script type="text/javascript" src="static/js/md5.js" ></script>
<script type="text/javascript" src="static/js/ajax.js" ></script>
<script type="text/javascript" src="static/layerSDK/layer.js" ></script>
<script type="text/javascript" src="static/js/common.js" ></script>-->
<script type="text/javascript">
//	"username=350111201201101097; roleCode=Student; Token=716b545a"
    $(function() {
        var roomid = $('#roomid').val(); //房间号
        var userid = $('#user_id').val();//学生id
        var techerid=$('#tid').val();//教师id
        var isRoleName=$('#roleName').val()=='教师'; //角色是否是教师
        var isRoleNameZ=$('#roleName').val()=='助教'; //角色是否是教师
        var roleCode=$('#roleCode').val();
        var liveid=$('#liveid').val();
        var Name=$("#Name").val();
        var username=userid;
        if(isRoleName || isRoleNameZ) {
        	username=roomid;
        }
        var isBottom = true; //是否刷新到底部
        var isBottomLength=0;
        var times = ''; //计时器
        var iswords=false;//禁言
        var isKickout=false;//提出房间
        if(isRoleName || isRoleNameZ){
        	if(isRoleName){
        		$("#my-video-all").remove();
        	}
        	if(isRoleNameZ){
        		$("#my-publisher-all").remove();
        	}
        	$("#copy").hide();
        	$("#worklist").hide();
        	$(".ation").hide();
        	$("#hudong").hide();
        	$("#copyValue").val("rtmp://streamsrv.xueerqin.net/hls/"+roomid+'t');
        }else{
        	$("#my-publisher-all").remove();
        	$("#publishBtn").hide();
        	$("#Offline").hide();
        	$("#endclass").hide();
//      	$("#begin").hide();
        	$(".count-list-top").hide();
        	$(".s-list-hide").hide();
        	$(".admins").hide();
        	$("#copyValue").val("rtmp://streamsrv.xueerqin.net/hls/"+userid);
        }
        fetch(); //初始化聊天列表
        fetchStuent(); //初始化学生直播窗口
        function fetch() {
            var checkboxs = $(".my-checkbox")[0].checked;
            var obj = {},myurl='chatContent';
            if (checkboxs) {
            	obj = {
                    sid: userid,
                    tid:techerid,
                    roomid:roomid
                }
            	myurl='showchat';
            } else {
                obj = {
                    roomid: roomid
                }
            }
            $.get(API +'/api/'+ myurl, obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '';
                res.data&&res.data.forEach(function(item) {
                    html += '<li class="flex">'
								+'<div>'
									+'<img src="https://lyg.goluckin.com/themes/v2/static/images/17yk.png"  style="width: 40px;"/>'
								+'</div>'
								+'<div>'
									+'<div class="title">'+item.chatname+' ['+getLocalTime(item.ctime)+']</div>';
										if(item.chatcontent=='「举手」'){
											html+='<div class="title_content cur-pointer" data-id="'+item.chatuserid+'">'+item.chatcontent+'</div>'
										}else{
											html+='<div class="title_content">'+item.chatcontent+'</div>'
										}
								+'</div>'
							+'</li>'
                })
                $("#subList").html(html);
                if(isRoleName || isRoleNameZ){
                	$(".cur-pointer").on("click",function(){
	                	changeStu($(this).attr("data-id"))
	                })
                }
                if (isBottom) {
                    $(".stutent-list").animate({
                        scrollTop: $(".stutent-list")[0].scrollHeight
                    }, 400);
                    isBottom = false;
                } else {
                	var rl=res.data.length;
                	if(rl>isBottomLength){
                		isBottomLength=rl;
                		$(".stutent-list").animate({
	                        scrollTop: $(".stutent-list")[0].scrollHeight
	                    }, 400);
                	}
//                  var sLT = $(".stutent-list")[0].scrollTop;
//                  var sLSH = $(".stutent-list")[0].scrollHeight;
//                  var sLH = $(".stutent-list").height();
//                  if (sLT > sLSH - sLH) {
//                      $(".stutent-list").animate({
//                          scrollTop: sLSH
//                      }, 400);
//                  };
                }
                times = setTimeout(function() {
                    fetch();
                }, 6000)
            })
        }
        //学生窗口
        var fetchStuentUrl='';
        function fetchStuent() {
            $.get(API + "/api/getstuadr", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.url) {
                	if(fetchStuentUrl!=res.url){
                		if(res.url==userid && !isRoleName){
	                		layer.confirm('是否开始直播？', {
							  	btn: ['确定','取消'] //按钮
							}, function(){
								$("#publishBtn").show();
								changeSrc("rtmp://streamsrv.xueerqin.net/hls/"+res.url,true);
							  	$("#publishBtn").click();
							  	layer.closeAll();
							  	drawPlugin.enableDraw(true);
							  	drawPlugin.setColor("#000");
							  	$("#Revoke").show();
//							  	$("#begin").show();
//      						$("#stop").show();
							  	$("#my-publisher2-all").css("z-index","100")
							}, function(){
							  changeStu('123456');
							});
	                	}else{
	                		if($(".openFlash").css('display')=='none' || isRoleName || isRoleNameZ){
	                			changeSrc("rtmp://streamsrv.xueerqin.net/hls/"+res.url,false);
		                		$("#my-publisher2-all").css("z-index","-100");
		                		if(!isRoleName && !isRoleNameZ){
		                			$("#publishBtn").hide();
		                			$("#Revoke").hide();
		                		}
		                		drawPlugin.enableDraw(false);
//		                		$("#begin").hide();
//	        					$("#stop").hide();
	                		}
	                	}
	                	fetchStuentUrl=res.url;
                	}
                }
                setTimeout(function() {
                    fetchStuent();
                }, 10000)
            })
            $.get(API + "/api/getuseronline", {
                roomid: roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = "";
                res.data&&res.data.forEach(function(item) {
                	if(item.uid==userid){
                		if(item.status.indexOf("1")>-1){
                			iswords=true;
                		}
                		if(item.status.indexOf("2")>-1){
                			location.reload()
                		}
                		if(item.status==''){
                			iswords=false;
                		}
                	}
                	html+='<li class="flex just-between align-center" data-id="'+item.uid+'">'
                                +'<div class="flex1"><img src="https://lyg.goluckin.com/themes/v2/static/images/17yk.png" />'+item.name+'</div>'
                                +'<div>'
                                	+'<div class="flex">'
                                		+'<div class="sn-btn" title="禁言" data-status="1">禁言</div>'
                                		+'<div class="sn-btn" title="踢出" data-status="2">踢出</div>'
                                		+'<div class="sn-btn" title="解除" data-status="3">解禁</div>'
                                	+'</div>'
                                +'</div>'
                            +'</li>';
                })

				$.get(API+"/userstatus/useronline", {
                	roomid: roomid
            	},function(){
            		
            	})
                $("#subList-online").html(html);
                if(isRoleName || isRoleNameZ){
                	$("#subList-online li").on("click", function(e) {
                		e.stopPropagation();
	                    changeStu($(this).attr("data-id"))
	                })
                	$(".sn-btn").on("click", function(e) {
                		e.stopPropagation();
	                    changeStuStatus($(this).attr("data-status"),$(this).closest(".align-center").attr("data-id"))
	                })
                	$.get(API+"/api/intvaltoken", {
	                	
	            	},function(){
	            		
	            	})
                }else{
                	$(".sn-btn").hide();
                }
            })
        }
        //监听切换私聊
        $(".my-checkbox").on("change",function(){
        	isBottom=true;
        	clearTimeout(times);
           	fetch();
        })
        //监听发送回车
        $("#send").on('keydown', function(e) {
            if (e.keyCode != 13) {
                return;
            } else { //当按键输入为回车时，执行下列操作
                event.preventDefault(); //为了兼容IE8
                e.returnValue = false;
                send();
            }
        });
        //发送按钮
        $("#btn").on("click", function() {
            send();
        })
        $("#hands").on("click",function(){
        	$.get(API + "/api/sendmsg", {
        		roomid: roomid,
                userid: userid,
                content: '「举手」'
        	}, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    layer.msg(res.msg);
                    return;
                }
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        })
        //发送消息
        function send() {
        	if(iswords) {
        		layer.msg("你已被禁言");
        		return;
        	}
        	if(isKickout) {
        		layer.msg("你已被踢出房间");
        		return;
        	}
            var sendVal = $("#send").val();
            if (sendVal == '') {
                layer.msg("发送不能为空！")
                return;
            }
            var checkboxs = $(".my-checkbox")[0].checked,
                obj = {};
            obj = {
                roomid: roomid,
                userid: userid,
                content: sendVal
            }
            if (checkboxs) {
                obj.touser = userid;
            }
            $.get(API + "/api/sendmsg", obj, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                if (res.status != 200) {
                    layer.msg(res.msg);
                    return;
                }
                $("#send").val('');
                isBottom = true;
                clearTimeout(times);
                fetch();
            })
        }
		//改变路径
        function changeSrc(src,isGo) {
        	var videoPlayer = $("#my-video2").get(0);
    		if (typeof (videoPlayer) != "undefined") {
    			var myPlayer = videojs('my-video2');
    			myPlayer.dispose();
    		}
    		if(isGo) return;
    		var id="my-video2";
    		var htmls='<video id="my-video2" style="color:black;width:100%;height:100%;position: relative;z-index: 1;" class="video-js" controls preload="auto" width="750" height="350">'
						+'<source id="my-source" src='+src+' type="rtmp/flv">'
					+'</video>'
    		$(".sudent-video").html(htmls);
            //设置资源路径
            $(".sudent-video").attr("src", src);
            videojs(id, {}, function () { //自动播放
            	this.play();
//          	this.pause();
//          	this.load();
            });
	    }
        //开始播放
        $("#begin").on("click",function(){
        	startPublish()
        })
        $("#share_now").on("click",function(){
        	$("#copyValue")[0].select();
        	document.execCommand("Copy");
        	layer.msg("复制地址成功，请到obs开始分享当前屏幕！");
        	setTimeout(function(){
        		changeStu(roomid+'t');
        	},3000)
        })
        //改变学生窗口播放源
        function changeStu(id){
        	$.get(API + "/api/setstuadr", {
                roomid: roomid,
                stuid:id
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                layer.msg("切换成功");
            })
        }
        function changeStuStatus(status,uid){
        	$.get(API + "/api/chataudit", {
                userid: uid,
                status:status,
                roomid:roomid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                layer.msg(res.msg);
            })
        }
        //复制源地址
        $("#copy").on("click",function(){
        	$("#copyValue")[0].select();
        	document.execCommand("Copy");
        	layer.msg("复制成功");
        })
        //作业列表
        $("#worklist").on("click",function(){
        	$.get(API + "/api/teacher_homework_list", {
                liveid: liveid
            }, function(res) {
                typeof res == "string" && (res = JSON.parse(res));
                var html = '<ul class="material">';
                res.data&&res.data.forEach(function(item) {
                    html += '<li class="flex just-between">'
				                +'<div>'+item.clName+'</div>'
				                +'<a href="'+item.path+'" target="_blank" class="material_btn">下载</a>'
				            +'</li>'
                })
                html+='</ul>';
                layer.open({
				  title: '作业列表',
					  area:['500px','auto'],
					  btn:[],
					  content: html
				}); 
            })
        })
        $("#Offline").on("click",function(){
        	changeStu("123456")
        })
        $("#endclass").on("click",function(){
        	onunload_handler();
        })
        $(".count-list").on("click",function(){
        	$(".count-list-c").eq($(this).index()).show().siblings(".count-list-c").hide();
        })
        
        window.onunload = onunload_handler; 
	    function onunload_handler(){
	        $.get(API+"/api/endClasses", {
	            userId: userid,
	            roleCode:roleCode,
	            roomId:roomid,
	            liveId:liveid,
	            endTime:getLocalTime(new Date().getTime()),
	            liveflag:'2',
	            url:document.URL,
	        }).then(function(res){
	        	typeof res == "string" && (res = JSON.parse(res));
	        	layer.msg("结束成功");
	        })
	        $.get(API+"/api/clearchat", {
	            roomId:roomid,
	        }).then(function(res){
	        	
	        })
	   	}
	    var EventUtil = { 
			addHandler: function (element, type, handler) { 
				if (element.addEventListener) { 
					element.addEventListener(type, handler, false); 
				} else if (element.attachEvent) { 
					element.attachEvent("on" + type, handler); 
				} else { 
					element["on" + type] = handler; 
				} 
			} 
		}; 
		EventUtil.addHandler(window, "online", function () { 
			layer.closeAll();
		}); 
		EventUtil.addHandler(window, "offline", function () { 
			layer.confirm('系统检测您已断网，是否需要刷新界面重连？', {
			  btn: ['确定','取消'] //按钮
			}, function(){
			   layer.closeAll();
			   location.reload() 
			}, function(){
			  layer.closeAll();
			});
		}); 
	    //白板模块
	    if(!username) return alert("未登录");
	    var nim='';
	    var wb='';
	    var drawPlugin='';
	    var appkey='1ee5a51b7d008254cd73b1d4369a9494';
	    var StoreWhiteBoard={};
	    var TeacherAccout=roomid.substring(roomid.length-10);
//	    var nim=wb=drawPlugin='',appkey='1ee5a51b7d008254cd73b1d4369a9494',StoreWhiteBoard={};
	    var wbAPI='https://app.netease.im/api';
	    //登录IM
	    login(username.substring(username.length-10),MD5('123456'));
	    
	    function login(account, token){
			NIM.use(WhiteBoard)
			nim = window.NIM.getInstance({
				debug: false,
		        appKey: appkey,
		        account:account,
		        token:token,
		        db: false,
		        syncSessionUnread: true,
		        syncRobots: true,
		        autoMarkRead: true, // 默认为true
		        ondisconnect:function (event) {
		        	if(event.code=="302"){
		        		regiset(account,token);
		        	}
		        },
		        onconnect: function(event) {
		          console.log(JSON.stringify(event)+"im连接成功...."+account);
		          initWB();
		        },
		        onmsg:function(event){
		        	console.log(event,"消息来咯，真的来咯")
		        },
		        oncustomsysmsg:function(event){
		        	var content=JSON.parse(event.content);
		        	if(content.type==1){
		        		layer.confirm(content.name+'要求白板互动请求，是否允许？', {
						  btn: ['允许','拒绝'] //按钮
						}, function(){
							sendCustomSysMsg(event,true);
							$("#endhudong").show();
							$("#endhudong").on("click",function(){
						    	sendCustomSysMsg(event,false);
						    	$("#endhudong").hide();
						    })
						  layer.closeAll();
						}, function(){
							sendCustomSysMsg(event,false);
						  layer.closeAll();
						});
		        	}else if(content.type==2){
		        		if(content.is){
		        			drawPlugin.enableDraw(true);
		        		}else{
		        			drawPlugin.enableDraw(false);
		        			layer.msg("白板互动取消！")
		        		}
		        	}
		        	console.log(event,"消息来咯，真的来咯2")
		        }
			})
		}
	    
	    function sendCustomSysMsg(event,is){
	    	nim.sendCustomSysMsg({
	    		scene: "p2p",
	    		to:event.from,
	    		content:JSON.stringify({
	    			type: 2,
	    			is:is
	    		})
	    	})
	    }
	    function joinChannelWb(roomId){
	    	if (!wb) return alert('wb::没有实例化');
	    	console.log(roomId,"房间号")
	    	if(!roomId) return alert('wb::没有房间号');
			wb.joinChannel({
	        	channelName: roomId
        	}).then(res=>{
        		console.log(res,11)
        		layer.msg('加入房间成功！');
        	}).catch(err=>{
        		console.log(err,22)
//      		if(isTeacher==1) return;
				if(!isRoleName) return layer.msg('教师尚未进入房间');
        		wb.createChannel({
		            channelName: roomId
		        }).then(res=>{
		        	console.log(res)
		        	joinChannelWb(roomId);
		        }).catch(err=>{
		        	console.log(err)
		        })
        	})
	    }
	    function initWB(){
	    	wb = WhiteBoard.getInstance({
				nim:nim,
				debug:true
			})
	    	drawPlugin = new DrawPlugin(document.getElementById("wbord"), {
			  UID: wb.getAccount(),
			  nim: nim  // nim实例
			})
	    	
	    	joinChannelWb(roomid); //加入白板房间
	    	
	    	drawPlugin.enableDraw(isRoleName); //是否可以操作白板
	    	
			drawPlugin.on('data', (obj) => {
			  let { toAccount = 0, data } = obj
			  wb.sendData({ toAccount, data })
			})
			
			wb.on('data', (obj) => {
			  drawPlugin.act({ account: obj.account, data: obj.data })
			});
			wb.on('joinChannel', function(obj) {
	            if(!isRoleName){
		    		console.log("请求历史数据",TeacherAccout)
		    		drawPlugin.syncRequest(TeacherAccout);
		    		return;
		    	}
	        })
			nim.on('notifyTransLog', function(data) {
	            console.log('notifyTransLog', data);
	            // data.state = WhiteBoardState.serializeFileStateMap['TRANSCOMPLETE'];
	            // data.percent = 100;
	            layer.closeAll();
		      	layer.msg("上传成功");
	            StoreWhiteBoard.data=data;
	        });
	    }
	    function regiset(account,token){
	    	ajax({
          		type:"POST",
          		url:wbAPI+"/createDemoUser",
          		dataType: "form",
          		headers:{
					appkey:appkey
				},
          		data:{
          			username: account,
				    nickname:'lyg'+account.substring(account.length-7),
				    password: token
          		}
          	}).then(res=>{
          		if(res.res==200){
          			login(account,token);
          		}
          	}).catch(err=>{
          		alert("注册出错！");
          	})
	    }
	    $("#file_ppt").on("change",function(e){
	    	if($(this).val()=='') return;
	    	var index = layer.load(1, {
			  shade: [0.1,'#fff'] //0.1透明度的白色背景
			});
	    	var fileInput=document.getElementById("file_ppt");
	    	const param = {
		      // 转码支持
		      transcode: 'jpg',
		      type: 'file',
		      fileInput:fileInput,
		      beginupload(data) {
		        // - 如果开发者传入 fileInput, 在此回调之前不能修改 fileInput
		        // - 在此回调之后可以取消图片上传, 此回调会接收一个参数 `upload`, 调用 `upload.abort();` 来取消文件上传
		        const { fileInputName, transtype, docId } = data.options;
		        console.log('beginupload', data.options);
		        console.log('fileInputName type', fileInputName, transtype);
		      },
		      uploadprogress(data) {
		        console.log('uploadprogress', data);
		      },
		      uploaddone(error, file) {
		        console.log('uploaddone', error, file, docId);
		      },
		      done(a, b) {
		        console.log('send file done', a, b);
		      }
		    };
		    nim.previewFile(param);
	    })
	    $("#getFliles").on("click",function(){
	    	getFliles()
	    })
	    var setImageObj={},pageIndx=1;
	    function getFliles(){
	    	nim.getFileList({
		      limit: 30,
		      success: function(data) {
		        console.log('getFileList success', data);
		        var html = '<ul class="material">';
                data.list.forEach(function(item,index) {
                    html += '<li class="flex just-between">'
				                +'<div>'+item.name+'</div>'
				                +'<div>'
					                +'<a href="javaScript:void(0)" data-index='+index+' class="material_btn material_btn2">使用</a>'
					                +'<a href="javaScript:void(0)" data-index='+index+' class="material_btn material_delete">删除</a>'
				                +'</div>'
				            +'</li>'
                })
                html+='</ul>';
                layer.open({
				  title: '课件列表',
					  area:['500px','auto'],
					  btn:[],
					  content: html
				}); 
				$(".material_btn2").on("click",function(){
					let i=$(this).attr("data-index");
					setImageObj=data.list[Number(i)];
					pageIndx=1;
					setImage();
					layer.closeAll();
				})
				$(".material_delete").on("click",function(){
					let i=$(this).attr("data-index");
					nim.deleteFile({
			            docId:data.list[i].docId,
			            error: function(a, b) {
			                console.error('deleteFile error', a, b);
			            },
			            success: function() {
			                console.log('deleteFile success');
			                getFliles();
			            }
			        });
				})
		      },
		      error: function(error) {
		        console.error('getFileList error', error);
		      }
		    });
	    }
	    function setImage(){
	    	var item=setImageObj;
	    	console.log('setImage', item);
	        let name = item.name.replace(/\.\w+$/, '');
	        let url = `${item.prefix}_${item.type}_${pageIndx}.jpg`;
	        url=url.replace("http","https");
	        console.log(url,66)
	        drawPlugin &&
	            drawPlugin.image({
	                url,
	                docId: item.docId,
	                pageCount: item.pageCount,
	                currentPage: pageIndx
	            });
	         $(".c-list-hide").css("display","block");
	         $("#page-num").text(pageIndx+"/"+(item.pageCount || 1));
	    }
	    $("#prevpages").on("click",function(){
	    	if(pageIndx<=1){
	    		return layer.msg("已经第一页了")
	    	}
	    	pageIndx--;
	    	setImage();
	    	
	    })
	    $("#nextspages").on("click",function(){
	    	if(pageIndx>=setImageObj.pageCount){
	    		return layer.msg("已经最后一页了")
	    	}
	    	pageIndx++;
	    	setImage();
	    })
	    $("#clearFile").on("click",function(){
	    	drawPlugin && drawPlugin.clearImage();
	    	$(".c-list-hide").hide();
	    })
	    $("#wb_clear").on("click",function(){
        	drawPlugin.clear();
        })
	    $("#Revoke").on("click",function(){
	    	drawPlugin.undo();
	    })
	    $("#hudong").on("click",function(){
	    	nim.sendCustomSysMsg({
	    		scene: "p2p",
	    		to:TeacherAccout,
	    		content:JSON.stringify({
	    			type: 1,
	    			name:Name
	    		}),
	    		done:function(error, msg){
	    			if (error) {return layer.msg("发起失败")}
	    			layer.msg("发起成功")
	    		}
	    	})
	    })
	    
    })
</script>
<script>
	var isRoleName=$('#roleName').val()=='教师'; //角色是否是教师
	var isRoleNameZ=$('#roleName').val()=='助教'; //角色是否是教师
	var userid = $('#user_id').val();//学生id
	var roomid = $('#roomid').val(); //房间号
	var isFang=false;
        var cameraList,
            microPhoneList,
            cameraOptions = '',
            microPhoneOptions = '';
        var publishBtn = document.getElementById('publishBtn');
        var previewBtn = document.getElementById('previewBtn')
        var testInput = document.getElementsByClassName('u-input');
        var ids='my-publisher2',mClass='.content-left-top2';
        if(isRoleName){
        	ids='my-publisher';
        	mClass='.content-left-top1';
        }
        var myPublisher = new nePublisher(ids, {
            //viewOptions
            videoWidth: $(mClass).width(),
            videoHeight: $(mClass).height(),
            fps: 20,
            bitrate: 1500
        }, {
            //flashOptions
            previewWindowWidth: $(mClass).width(),
            previewWindowHeight: $(mClass).height(),
            wmode: 'transparent',
            quality: 'medium',
            allowScriptAccess: 'always'
        }, function() {
            cameraList = this.getCameraList();
            microPhoneList = this.getMicroPhoneList();
            if(cameraList.length==0){
            	isFang=true;
            }
            if(cameraList.length > 0 && cameraList[0]==" "){
            	isFang=true;
            }
            console.log(cameraList, microPhoneList);
            for (var i = cameraList.length - 1; i >= 0; i--) {
                cameraOptions = '<option value="' + i + '">' + cameraList[i] + '</option>' + cameraOptions;
            }
            for (var i = microPhoneList.length - 1; i >= 0; i--) {
                microPhoneOptions = '<option value="' + i + '">' + microPhoneList[i] + '</option>' + microPhoneOptions;
            }
            document.getElementById("cameraSelect").innerHTML = cameraOptions;
            document.getElementById("microPhoneSelect").innerHTML = microPhoneOptions;
            
        }, function(code, desc) {
            console.log(code, desc);
            isFang=true;
            alert(desc)
        });
        var qualityList = [
            {
                //流畅
                fps: 20,
                bitrate: 600,
                videoWidth:480,
                videoHeight:360
            },
            {
                //标清
                fps: 20,
                bitrate: 800,
                videoWidth:640,
                videoHeight:480
            },
            {
                //高清
                fps: 20,
                bitrate: 1500,
                videoWidth:960,
                videoHeight:540
            }
        ];
        var getCameraIndex = function() {
            var cameraSelect = document.getElementById("cameraSelect");
            var cameraIndex = cameraSelect.selectedIndex;
            return cameraSelect.options[cameraIndex].value;
        };
        var getMicroPhoneIndex = function() {
            var microPhoneSelect = document.getElementById("microPhoneSelect");
            var microPhoneIndex = microPhoneSelect.selectedIndex;
            return microPhoneSelect.options[microPhoneIndex].value;
        };
        var getQualityOption = function() {
            var qualitySelect = document.getElementById("qualitySelect");
            var qualityIndex = qualitySelect.selectedIndex;
            return qualityList[qualityIndex];
        };
        var startPreview = function() {
            myPublisher.startPreview(getCameraIndex());
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
        };
        var startPublish = function() {
        	if(isFang) return alert("获取摄像头失败！");
        	if(isRoleNameZ){
        		$.get(API + "/api/setstuadr", {
	                roomid:roomid,
	                stuid:userid
	            }, function(res) {
	                typeof res == "string" && (res = JSON.parse(res));
	            })
        	}
            var publishUrl = "rtmp://streamsrv.xueerqin.net/hls/"+(isRoleName==true ? roomid : userid);
            startPublishCall();
            myPublisher.setCamera(getCameraIndex());
            myPublisher.setMicroPhone(getMicroPhoneIndex());
            myPublisher.startPublish(publishUrl, getQualityOption(),function(code, desc) {
                console.log(code, desc);
                alert(code + '：' + desc);
                stopPublishCall();
            });
        };
        var stopPublish = function() {
            myPublisher.stopPublish();
            myPublisher.stopPreview();
            stopPublishCall();
        };
        var startPublishCall = function() {
            console.log('推流开始');
            document.getElementsByClassName('u-status')[0].innerHTML = '直播中';
            publishBtn.innerHTML = '停止直播';
            publishBtn.onclick = stopPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = true;
            }
            previewBtn.disabled = true;
        };
        var stopPublishCall = function() {
            console.log('推流结束');
            document.getElementsByClassName('u-status')[0].innerHTML = '预览中';
            publishBtn.innerHTML = '开始直播';
            publishBtn.onclick = startPublish;
            for (var i = testInput.length - 1; i >= 0; i--) {
                testInput[i].disabled = false;
            }
            previewBtn.disabled = false;
        };
</script>
</html>